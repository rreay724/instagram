!function(e,t,n){var i={BACKSPACE:8,TAB:9,RETURN:13,ESC:27,LEFT:37,UP:38,RIGHT:39,DOWN:40,COMMA:188,SPACE:32,HOME:36,END:35},a={triggerChar:"@",onDataRequest:e.noop,minChars:2,allowRepeat:!1,showAvatars:!0,elastic:!0,defaultValue:"",onCaret:!1,classes:{autoCompleteItemActive:"active"},templates:{wrapper:t.template('<div class="mentions-input-box"></div>'),autocompleteList:t.template('<div class="mentions-autocomplete-list"></div>'),autocompleteListItem:t.template('<li data-ref-id="<%= id %>" data-ref-type="<%= type %>" data-display="<%= display %>"><%= content %></li>'),autocompleteListItemAvatar:t.template('<img src="<%= avatar %>" />'),autocompleteListItemIcon:t.template('<div class="icon <%= icon %>"></div>'),mentionsOverlay:t.template('<div class="mentions"><div></div></div>'),mentionItemSyntax:t.template("@[<%= id %>]"),mentionItemHighlight:t.template("<strong><span><%= value %></span></strong>")}},o={htmlEncode:function(e){return t.escape(e)},regexpEncode:function(e){return e.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1")},highlightTerm:function(e,t){return t||t.length?e.replace(new RegExp("(?![^&;]+;)(?!<[^<>]*)("+t+")(?![^<>]*>)(?![^&;]+;)","gi"),"<b>$1</b>"):e},setCaratPosition:function(e,t){if(e.createTextRange){var n=e.createTextRange();n.move("character",t),n.select()}else e.selectionStart?(e.focus(),e.setSelectionRange(t,t)):e.focus()},rtrim:function(e){return e.replace(/\s+$/,"")}},r=function(n){var r,s,l,c,d,p,u=[],f={},m=[],h="";function g(){var e=w();t.each(u,function(t){var i=n.templates.mentionItemSyntax(t);e=e.replace(new RegExp(o.regexpEncode(t.value),"g"),i)});var i=o.htmlEncode(e);t.each(u,function(e){var a=t.extend({},e,{value:o.htmlEncode(e.value)}),r=n.templates.mentionItemSyntax(a),s=n.templates.mentionItemHighlight(a);i=i.replace(new RegExp(o.regexpEncode(r),"g"),s)}),i=(i=i.replace(/\n/g,"<br />")).replace(/ {2}/g,"&nbsp; "),r.data("messageText",e),r.trigger("updated"),d.find("div").html(i)}function v(){m=[]}function x(e){for(var i=w(),a=r[0].selectionStart,s=!1,l=!1,c=new RegExp("\\"+n.triggerChar+h,"gi");c.exec(i);)(!1===s||Math.abs(c.lastIndex-a)<s)&&(s=Math.abs(c.lastIndex-a),l=c.lastIndex);var d=l-h.length-1,p=l,f=i.substr(0,d),m=i.substr(p,i.length),x=(f+e.value).length+1;t.find(u,function(t){return t.id==e.id})||u.push(e),v(),h="",S();var b=f+e.value+" "+m;r.val(b),r.trigger("mention"),g(),r.focus(),o.setCaratPosition(r[0],x)}function w(){return e.trim(r.val())}function b(t){var n,i,a=e(this);return x(f[a.attr("data-uid")]),n=e(r).offset().top,i=e("body").offset().top,e(window).scrollTop()>n&&e(window).scrollTop(n-i),!1}function C(e){v()}function E(e){S()}function y(e){var i;g(),i=w(),u=t.reject(u,function(e,t){return!e.value||-1==i.indexOf(e.value)}),u=t.compact(u);var a=t.lastIndexOf(m,n.triggerChar);a>-1&&(h=m.slice(a+1).join(""),h=o.rtrim(h),t.defer(t.bind(k,this,h)))}function T(e){if(e.keyCode!==i.BACKSPACE){var t=String.fromCharCode(e.which||e.keyCode);m.push(t)}}function I(n){if(n.keyCode===i.LEFT||n.keyCode===i.RIGHT||n.keyCode===i.HOME||n.keyCode===i.END)return t.defer(v),void(navigator.userAgent.indexOf("MSIE 9")>-1&&t.defer(g));if(n.keyCode!==i.BACKSPACE){if(!l.is(":visible"))return!0;switch(n.keyCode){case i.UP:case i.DOWN:var a=null;return(a=n.keyCode===i.DOWN?p&&p.length?p.next():l.find("li").first():e(p).prev()).length&&A(a),!1;case i.RETURN:case i.TAB:if(p&&p.length)return p.trigger("mousedown"),!1}return!0}m=m.slice(0,-1+m.length)}function S(){p=null,l.empty().hide()}function A(e){e.addClass(n.classes.autoCompleteItemActive),e.siblings().removeClass(n.classes.autoCompleteItemActive),p=e}function R(i,a){if(l.show(),!n.allowRepeat){var s=t.pluck(u,"value");a=t.reject(a,function(e){return t.include(s,e.name)})}if(a.length){l.empty();var c=e("<ul>").appendTo(l).hide();t.each(a,function(a,r){var s=t.uniqueId("mention_");f[s]=t.extend({},a,{value:a.name});var l=e(n.templates.autocompleteListItem({id:o.htmlEncode(a.id),display:o.htmlEncode(a.name),type:o.htmlEncode(a.type),content:o.highlightTerm(o.htmlEncode(a.display?a.display:a.name),i)})).attr("data-uid",s);(0===r&&A(l),n.showAvatars)&&(a.avatar?e(n.templates.autocompleteListItemAvatar({avatar:a.avatar})):e(n.templates.autocompleteListItemIcon({icon:a.icon}))).prependTo(l);l=l.appendTo(c)}),l.show(),n.onCaret&&function(t,n){var i=t.css("position");if("absolute"==i){var a=function(t){var n,i,a,o,r,s,l,c,d,p,u;if((d=t[0])&&e(d).is("textarea")&&null!=d.selectionEnd){for(l={position:"absolute",overflow:"auto",whiteSpace:"pre-wrap",wordWrap:"break-word",boxSizing:"content-box",top:0,left:-9999},p=0,u=(c=["boxSizing","fontFamily","fontSize","fontStyle","fontVariant","fontWeight","height","letterSpacing","lineHeight","paddingBottom","paddingLeft","paddingRight","paddingTop","textDecoration","textIndent","textTransform","width","word-spacing"]).length;p<u;p++)l[r=c[p]]=e(d).css(r);return a=document.createElement("div"),e(a).css(l),e(d).after(a),i=document.createTextNode(d.value.substring(0,d.selectionEnd)),n=document.createTextNode(d.value.substring(d.selectionEnd)),(o=document.createElement("span")).innerHTML="&nbsp;",a.appendChild(i),a.appendChild(o),a.appendChild(n),a.scrollTop=d.scrollTop,s=e(o).position(),e(a).remove(),s}}(n),o=parseInt(n.css("line-height"),10)||18;t.css("width","15em"),t.css("left",a.left),t.css("top",o+a.top);var r=n.offset().left+n.width(),s=t.offset().left+t.width();r<=s&&t.css("left",Math.abs(t.position().left-(s-r)))}else if("fixed"==i){var l=function(t){var n,i,a,o,r,s,l,c,d,p,u;if((d=t[0])&&e(d).is("textarea")&&null!=d.selectionEnd){for(l={position:"absolute",overflow:"auto",whiteSpace:"pre-wrap",wordWrap:"break-word",boxSizing:"content-box",top:0,left:-9999},p=0,u=(c=["boxSizing","fontFamily","fontSize","fontStyle","fontVariant","fontWeight","height","letterSpacing","lineHeight","paddingBottom","paddingLeft","paddingRight","paddingTop","textDecoration","textIndent","textTransform","width","word-spacing"]).length;p<u;p++)l[r=c[p]]=e(d).css(r);return a=document.createElement("div"),e(a).css(l),e(d).after(a),i=document.createTextNode(d.value.substring(0,d.selectionEnd)),n=document.createTextNode(d.value.substring(d.selectionEnd)),(o=document.createElement("span")).innerHTML="&nbsp;",a.appendChild(i),a.appendChild(o),a.appendChild(n),a.scrollTop=d.scrollTop,s=e(o).offset(),e(a).remove(),s}}(n),o=parseInt(n.css("line-height"),10)||18;t.css("width","15em"),t.css("left",l.left+1e4),t.css("top",o+l.top)}}(l,r),c.show()}else S()}function k(e){e&&e.length&&e.length>=n.minChars?n.onDataRequest.call(this,"search",e,function(t){R(e,t)}):S()}function M(e){u=[];for(var t,i=o.htmlEncode(e),a=new RegExp("("+n.triggerChar+")\\[(.*?)\\]\\((.*?):(.*?)\\)","gi"),s=i;null!=(t=a.exec(i));)s=s.replace(t[0],t[1]+t[2]),u.push({id:t[4],type:t[3],value:t[2],trigger:t[1]});r.val(s),g()}return n=e.extend(!0,{},a,n),{init:function(t){"true"!==(r=e(t)).attr("data-mentions-input")&&(s=r.parent(),c=e(n.templates.wrapper()),r.wrapAll(c),c=s.find("> div.mentions-input-box"),r.attr("data-mentions-input","true"),r.bind("keydown",I),r.bind("keypress",T),r.bind("click",C),r.bind("blur",E),navigator.userAgent.indexOf("MSIE 8")>-1?r.bind("propertychange",y):r.bind("input",y),n.elastic&&r.elastic()),(l=e(n.templates.autocompleteList())).appendTo(c),l.delegate("li","mousedown",b),(d=e(n.templates.mentionsOverlay())).prependTo(c),M(n.defaultValue),n.prefillMention&&x(n.prefillMention)},val:function(e){t.isFunction(e)&&e.call(this,u.length?r.data("messageText"):w())},reset:function(){M()},reinit:function(){M(!1)},getMentions:function(e){t.isFunction(e)&&e.call(this,u)}}};e.fn.mentionsInput=function(n,i){var a=arguments;return"object"!=typeof n&&n||(i=n),this.each(function(){var o=e.data(this,"mentionsInput")||e.data(this,"mentionsInput",new r(i));return t.isFunction(o[n])?o[n].apply(this,Array.prototype.slice.call(a,1)):"object"!=typeof n&&n?void e.error("Method "+n+" does not exist"):o.init.call(this,this)})}}(jQuery,_);